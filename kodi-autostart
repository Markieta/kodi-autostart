#!/usr/bin/env bash

export DISPLAY=:0

retroarch=$( /usr/bin/xmllint \
    --xpath 'string(//settings/setting[@id="iarl_path_to_retroarch"]/@value)' \
    /home/kodi/.kodi/userdata/addon_data/plugin.program.iarl/settings.xml
)

steam=$( /usr/bin/xmllint \
    --xpath 'string(//settings/setting[@id="SteamLinux"]/@value)' \
    /home/kodi/.kodi/userdata/addon_data/script.steam.launcher/settings.xml
)

while true
do
    until ping -qc1 vizio > /dev/null 2>&1; do :; done

    /usr/bin/xinit /usr/bin/dbus-launch --exit-with-session \
    /usr/bin/kodi-standalone -- :0 -nolisten tcp vt7

    journalctl=$(journalctl -u kodi.service --since "30 seconds ago")
    retroarch_launch=$(echo "$journalctl" | grep "$retroarch" | tail -1 | cut -d' ' -f6-)

    if [ -n "$retroarch_launch" ]; then
        launch_command=$(echo $retroarch_launch | cut -d' ' -f1-3)
        launch_rom=$(echo $retroarch_launch | cut -d' ' -f4-)

        sleep 1 && /usr/bin/xrandr -s 1920x1080 -r 60 &

        /usr/bin/xinit /usr/bin/dbus-launch --exit-with-session \
            $launch_command "$launch_rom" -- :0 -nolisten tcp vt7
    fi
done
